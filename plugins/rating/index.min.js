!function(){"use strict";var t={url:"https://kinopoiskapiunofficial.tech/",rating_url:"https://rating.kinopoisk.ru/",api_key:"",cache_time:24};function e(t){switch(t){case 401:return"Неправильный API ключ. Проверьте настройки плагина.";case 402:return"Превышен лимит запросов (или дневной, или общий).";case 403:return"Фильм не найден.";case 429:return"Слишком много запросов.";default:return null}}function i(i){var a=new Lampa.Reguest,n=u(i.title).replace(/^[ \/\\]+/,"").replace(/[ \/\\]+$/,"").replace(/\+( *[+\/\\])+/g,"+").replace(/([+\/\\] *)+\+/g,"+").replace(/( *[\/\\]+ *)+/g,"+"),r=i.release_date||i.first_air_date||i.last_air_date||"0000",l=parseInt((r+"").slice(0,4)),m=i.original_title||i.original_name,o={url:Lampa.Storage.get("rating_url",t.url),rating_url:Lampa.Storage.get("rating_rating_url",t.rating_url),api_key:Lampa.Storage.get("rating_api_key",t.api_key),cache_time:60*Lampa.Storage.get("rating_cache_time",t.cache_time)*60*1e3},p={id:i.id,url:""+o.url,rating_url:""+o.rating_url,headers:{"X-API-KEY":o.api_key},cache_time:o.cache_time};function g(t){if(!t||!t.length)return h(f(p.id,{kp:0,imdb:0,timestamp:(new Date).getTime()}));var n=!1,r=!1;if(t.forEach((function(t){var e=t.start_date||t.year||"0000";t.tmp_year=parseInt((e+"").slice(0,4))})),i.imdb_id){var o=t.filter((function(t){return(t.imdb_id||t.imdbId)==i.imdb_id}));o.length&&(t=o,n=!0,r=!0)}var g=t;if(g.length){if(m){var u=g.filter((function(t){return d(t.orig_title||t.nameOriginal,m)||d(t.en_title||t.nameEn,m)||d(t.title||t.ru_title||t.nameRu,m)}));u.length&&(g=u,n=!0)}if(i.title){var c=g.filter((function(t){return d(t.title||t.ru_title||t.nameRu,i.title)||d(t.en_title||t.nameEn,i.title)||d(t.orig_title||t.nameOriginal,i.title)}));c.length&&(g=c,n=!0)}if(g.length>1&&l){var v=g.filter((function(t){return t.tmp_year==l}));v.length||(v=g.filter((function(t){return t.tmp_year&&t.tmp_year>l-2&&t.tmp_year<l+2}))),v.length&&(g=v)}}if(1==g.length&&n&&!r&&(l&&g[0].tmp_year&&(n=g[0].tmp_year>l-2&&g[0].tmp_year<l+2),n&&(n=!1,m&&(n|=s(g[0].orig_title||g[0].nameOriginal,m)||s(g[0].en_title||g[0].nameEn,m)||s(g[0].title||g[0].ru_title||g[0].nameRu,m)),i.title&&(n|=s(g[0].title||g[0].ru_title||g[0].nameRu,i.title)||s(g[0].en_title||g[0].nameEn,i.title)||s(g[0].orig_title||g[0].nameOriginal,i.title)))),1!=g.length||!n)return h(f(p.id,{kp:0,imdb:0,timestamp:(new Date).getTime()}));var k=g[0].kp_id||g[0].kinopoisk_id||g[0].kinopoiskId||g[0].filmId,y=function(){a.clear(),a.timeout(15e3),a.silent(p.url+"api/v2.2/films/"+k,(function(t){return h(f(p.id,{kp:t.ratingKinopoisk,imdb:t.ratingImdb,timestamp:(new Date).getTime()}))}),(function(t,i){var n=e(t.status);_(n||a.errorDecode(t,i))}),!1,{headers:p.headers})};a.clear(),a.timeout(5e3),a.native(p.rating_url+k+".xml",(function(t){if(t.indexOf("<rating>")>=0)try{var e=0,i=0,a=$($.parseXML(t)),n=a.find("kp_rating");n.length&&(e=parseFloat(n.text()));var r=a.find("imdb_rating");return r.length&&(i=parseFloat(r.text())),h(f(p.id,{kp:e,imdb:i,timestamp:(new Date).getTime()}))}catch(t){}y()}),(function(t,e){y()}),!1,{dataType:"text"})}function u(t){return t.replace(/[\s.,:;’'`!?]+/g," ").trim()}function c(t){return u(t.toLowerCase().replace(/[\-\u2010-\u2015\u2E3A\u2E3B\uFE58\uFE63\uFF0D]+/g,"-").replace(/ё/g,"е"))}function s(t,e){return"string"==typeof t&&"string"==typeof e&&c(t)===c(e)}function d(t,e){return"string"==typeof t&&"string"==typeof e&&-1!==c(t).indexOf(c(e))}function _(t){Lampa.Noty.show("Рейтинг KP: "+t)}function f(t,e){var i=(new Date).getTime(),a=Lampa.Storage.cache("kp_rating",500,{});return a[t]?i-a[t].timestamp>p.cache_time?(e.timestamp=i,a[t]=e,Lampa.Storage.set("kp_rating",a)):e=a[t]:(a[t]=e,Lampa.Storage.set("kp_rating",a)),e}function h(t){if(t){var e=isNaN(t.kp)||null===t.kp?"0.0":parseFloat(t.kp).toFixed(1),i=isNaN(t.imdb)||null===t.imdb?"0.0":parseFloat(t.imdb).toFixed(1),a=Lampa.Activity.active().activity.render();$(".wait_rating",a).remove(),$(".rate--imdb",a).removeClass("hide").find("> div").eq(0).text(i),$(".rate--kp",a).removeClass("hide").find("> div").eq(0).text(e)}}!function(){var t=function(t){var e=(new Date).getTime(),i=Lampa.Storage.cache("kp_rating",500,{});if(!i[t])return!1;if(e-i[t].timestamp>p.cache_time)return delete i[t],Lampa.Storage.set("kp_rating",i),!1;return i}(p.id);if(t)return h(t[p.id]);if(""===o.api_key)return void _("Не задан API ключ. Рейтинг получить невозможно, зайдите в настройки плагина.");!function(){var t=p.url,r=Lampa.Utils.addUrlComponent(t+"api/v2.1/films/search-by-keyword","keyword="+encodeURIComponent(n));t=i.imdb_id?Lampa.Utils.addUrlComponent(t+"api/v2.2/films","imdbId="+encodeURIComponent(i.imdb_id)):r;a.clear(),a.timeout(15e3),a.silent(t,(function(i){i.items&&i.items.length?g(i.items):i.films&&i.films.length?g(i.films):t!==r?(a.clear(),a.timeout(15e3),a.silent(r,(function(t){t.items&&t.items.length?g(t.items):t.films&&t.films.length?g(t.films):g([])}),(function(t,i){var n=e(t.status);_(n||a.errorDecode(t,i))}),!1,{headers:p.headers})):g([])}),(function(t,i){var n=e(t.status);_(n||a.errorDecode(t,i))}),!1,{headers:p.headers})}()}()}window.rating_plugin||(window.rating_plugin=!0,function(){try{Lampa.SettingsApi.removeComponent&&Lampa.SettingsApi.removeComponent("rating_plugin")}catch(t){}Lampa.SettingsApi.addComponent({component:"rating_plugin",name:"Рейтинг Кинопоиск/IMDB",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"/></svg>'}),Lampa.SettingsApi.addParam({component:"rating_plugin",param:{name:"rating_url",type:"input",placeholder:t.url,values:Lampa.Storage.get("rating_url",t.url),default:t.url},field:{name:"URL для API Кинопоиска",description:"Базовый URL для API Кинопоиска"},onChange:function(e){Lampa.Storage.set("rating_url",e||t.url)}}),Lampa.SettingsApi.addParam({component:"rating_plugin",param:{name:"rating_rating_url",type:"input",placeholder:t.rating_url,values:Lampa.Storage.get("rating_rating_url",t.rating_url),default:t.rating_url},field:{name:"URL для рейтинга",description:"URL для сервиса rating.kinopoisk.ru"},onChange:function(e){Lampa.Storage.set("rating_rating_url",e||t.rating_url)}}),Lampa.SettingsApi.addParam({component:"rating_plugin",param:{name:"rating_api_key",type:"input",placeholder:t.api_key,values:Lampa.Storage.get("rating_api_key",t.api_key),default:t.api_key},field:{name:"Ключ API",description:'Зарегистрируйтесь на сайте kinopoiskapiunofficial.tech и введите ваш API-KEY из раздела "Профиль"'},onChange:function(e){Lampa.Storage.set("rating_api_key",e||t.api_key)}}),Lampa.SettingsApi.addParam({component:"rating_plugin",param:{name:"rating_cache_time",type:"select",values:{1:"1 час",6:"6 часов",12:"12 часов",24:"24 часа",48:"48 часов",72:"72 часа",168:"1 неделя"},default:t.cache_time.toString()},field:{name:"Время кеширования",description:"Как долго хранить данные о рейтинге"},onChange:function(e){Lampa.Storage.set("rating_cache_time",parseInt(e)||t.cache_time)}})}(),Lampa.Listener.follow("full",(function(t){if("complite"==t.type){var e=t.object.activity.render();$(".rate--kp",e).hasClass("hide")&&!$(".wait_rating",e).length&&($(".info__rate",e).after('<div style="width:2em;margin-top:1em;margin-right:1em" class="wait_rating"><div class="broadcast__scan"><div></div></div><div>'),i(t.data.movie))}})))}();